import { createServerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { NAV_SECTIONS } from '@/lib/nav/links';

export async function GET() {
  const supabase = createServerClient({ cookies });
  const { data: user } = await supabase.auth.getUser();

  const role = user.user?.role ?? null;

  const { data: prefs } = await supabase
    .from('nav_preferences')
    .select('*')
    .eq('user_id', user.user?.id)
    .single();

  const disabledFlags = prefs?.disabled_flags ?? [];
  const enabledLinks = prefs?.enabled_links ?? [];

  const filtered = NAV_SECTIONS.map((section) => ({
    ...section,
    routes: section.routes.filter((r) => {
      const roleMatch = !r.roles || r.roles.includes(role);
      const flagMatch = !r.flags || !r.flags.some((f) => disabledFlags.includes(f));
      const enabled = !enabledLinks.length || enabledLinks.includes(r.href);
      return roleMatch && flagMatch && enabled;
    }),
  }));

  return new Response(JSON.stringify(filtered), {
    headers: { 'Content-Type': 'application/json' },
  });
}
